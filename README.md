# Setup for M-pesa stkpush and stkpushquery on Rails APIs.

### Daraja Safaricom Developers Portal ~ Setup

- Get started by login in or create [Daraja Developer](https://developer.safaricom.co.ke/) free Account.
- On apps tab, create a new sandbox app and give it your preferd name. Proceed to tick all the check boxes and click on create app.
- You will be redirected to the app details page where you will find your consumer key and consumer secret. This will be crucial later during setup.
- Navigate to the APIs tab and on M-pesa Express click on Simulate, on the input prompt select the app you just created.
- Scroll down and click on test credentials. The initiator password and passkey will crucial also later.

### Ngrok ~ Setup

- Login or create [ngrok](https://ngrok.com/) free account.
- Install on ubuntu by `sudo snap install ngrok` or download from website.
- Connect your account to ngrok run `ngrok authtoken <your authtoken>`.

### Rails ~ Setup

- Create a new rails app `rails new <name> --api --minimal`.
- Install or Add Gems below.

```ruby
gem 'rest-client'
gem 'rack-cors'
```

- Run `bundle install`.

- Create M-pesa resource. Run `rails g resource Mpesa phoneNumber amount checkoutRequestID  merchantRequestID mpesaReceiptNumber --no-test-framework`.
- Also add Access Token. Run ` rails g model AccessToken token --no-test-framework`.
- Run `rails db:migrate`

### Configurations

- Navigate to `config/environments/development.rb` and add the following code.

```ruby
config.hosts << /[a-z0-9]+\.ngrok\.io/
```

> **This will allow us to access our rails app from ngrok**.

- Navigate to `config/initializers/cors.rb` and add the following code or uncomment the existing code.

```ruby
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins "*"

    resource "*",
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head]
  end

end
```

> **Be sure to replace origins 'example.com' with origins '\*' if you uncomment existing code.**

### Config Environment Variables

- Inside the config folder create a file `config/local_env.yml` and add the following code.

```ruby
MPESA_CONSUMER_KEY: "<your consumer key>"
MPESA_CONSUMER_SECRET: "<your consumer secret>"
MPESA_SHORTCODE: "<your mpesa shortcode>"
MPESA_INITIATOR_NAME: "testapi"
MPESA_PASSKEY: "<your passkey>"
MPESA_INITIATOR_PASSWORD: "<your initiator password>"
CALLBACK_URL: "<your ngrok url>"
REGISTER_URL: "https://sandbox.safaricom.co.ke/mpesa/c2b/v1/registerurl"
```

> **IMPORTANT:** Add the local_env.yml to the .gitignore file to hide your Daraja Consumer Key and Secret.

### Note about the CALLBACK_URL.

- To aquire callback url, run your rails server `rails s` and copy the url `http://127.0.0.1:3000` from the terminal.
- Open a new terminal for ngrok and run `ngrok http <port number>` and replace `<port number>` with the port number from your rails server `http://127.0.0.1:3000` hence generating a url that you can use as your callback_url.
- My example: `ngrok http http://127.0.0.1:3000` and the url generated is `https://d0e6-154-154-16-76.in.ngrok.io`

  > **Note** that the url generated by ngrok changes every time you run it, so you will need to update your local_env.yml file with the new url every time you run ngrok.

- Navigate to ngrok url, to open the link, click on visit site which should take you to your rails app. If you get a `Blocked Host Error`, check out this stackoverflow [solutions](https://stackoverflow.com/questions/53878453/upgraded-rails-to-6-getting-blocked-host-error).
- The solution that worked for my test is to replace `config.hosts << /[a-z0-9]+\.ngrok\.io/` with ` config.hosts.clear` in `config/environments/development.rb`, though this is not recommended for production.

- To load rails on our environment variables, add the following code to `config/application.rb`.

```ruby
config.before_configuration do
  env_file = File.join(Rails.root, 'config', 'local_env.yml')
  YAML.load(File.open(env_file)).each do |key, value|
    ENV[key.to_s] = value
  end if File.exists?(env_file)
end
```

### Author Info

- [Felix Barosio](https://github.com/Felix-Barosio) ~ [Email](barosiofelix@gmail.com)
